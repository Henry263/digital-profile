/* Minified by Terser */
async function getRealPublicIP(){try{const e=await fetch("/api/card/get-client-ip"),t=await e.json();return t.success?t.ip:null}catch(e){return console.error("Failed to get public IP:",e),null}}let userPublicIP=null;!async function(){userPublicIP=await getRealPublicIP()}();let currentUser=null;class SmartLifeCoverAPI{constructor(e=window.location.origin){this.baseURL=e,this.token=this.getToken()}getToken(){return localStorage.getItem("authToken")||null}setToken(e){this.token=e,localStorage.setItem("authToken",e)}clearToken(){this.token=null,localStorage.removeItem("authToken")}async apiRequest(e,t={}){const n=`${this.baseURL}${e}`,o={headers:{"Content-Type":"application/json",...t.headers},credentials:"include",...t};try{const e=await fetch(n,o),t=await e.json();if(!e.ok)throw new Error(t.message||"API request failed");return t}catch(e){throw console.error("API Request Error:",e),e}}async checkAuthStatus(){try{return(await this.apiRequest("/auth/status")).authenticated}catch(e){return!1}}async getCurrentUser(){return this.apiRequest("/auth/me")}async logout(){try{return await this.apiRequest("/auth/logout",{method:"POST"}),this.clearToken(),!0}catch(e){return console.error("Logout error:",e),this.clearToken(),!1}}async getProfile(){try{return await this.apiRequest("/api/profile")}catch(e){return console.error("Get profile error:",e),{success:!1,error:e.message}}}async saveProfile(e){return this.apiRequest("/api/profile",{method:"POST",body:JSON.stringify(e)})}async uploadQRCode(e){const t=new FormData;return t.append("qrCode",e),this.apiRequest("/api/profile/upload-qr",{method:"POST",headers:{},body:t})}async updatesuggestions(e){return this.apiRequest("/api/suggestions",{method:"POST",body:JSON.stringify(e)})}async updatecontactinfo(e){return this.apiRequest("/api/contact",{method:"POST",body:JSON.stringify(e)})}async deleteProfile(){return this.apiRequest("/api/profile",{method:"DELETE"})}async getAnalytics(){return this.apiRequest("/api/profile/analytics")}async getPublicCard(e){return this.apiRequest(`/api/card/${e}`)}async downloadVCard(e){const t=`${this.baseURL}/api/card/${e}/vcard`;window.open(t,"_blank")}async downloadWalletPass(e){const t=`${this.baseURL}/api/card/${e}/wallet-pass`;window.open(t,"_blank")}async getQRCode(e,t=400){return`${this.baseURL}/api/card/${e}/qr?size=${t}`}async getstyledQRCode(e,t=400){return`${api.baseURL}/api/card/${e}/download-styled-qr`}async trackSocialClick(e,t){return this.apiRequest(`/api/card/${e}/track/${t}`,{method:"POST"})}async trackContactClick(e,t){return this.apiRequest(`/api/card/${e}/track/contact/${t}`,{method:"POST"})}async searchCards(e,t=10){return this.apiRequest(`/api/card/search/${encodeURIComponent(e)}?limit=${t}`)}}const api=new SmartLifeCoverAPI;async function loginWithGoogle(){window.location.href=`${api.baseURL}/auth/google`}async function signupWithGoogle(){window.location.href=`${api.baseURL}/auth/google`}function showError(e,t){const n=document.getElementById(e);if(n.style.borderColor="#dc3545",n.style.backgroundColor="#fff5f5",["instagram","facebook","twitter","linkedin","calendly","zoom","snapchat","tiktok","youtube","whatsapp","telegram","reddit","pinterest"].includes(e)){const e=n.closest(".social-item").querySelector(".input-error");e&&(e.innerHTML=`\n                <div class="error-message" style="\n                    color: #dc3545;\n                    font-size: 0.875rem;\n                    margin-top: 0.5rem;\n                    font-weight: 500;\n                    display: block;\n                    width: 100%;\n                ">${t}</div>\n            `)}else{const e=n.closest(".form-group").querySelector(".error-message");e&&e.remove();const o=document.createElement("div");o.className="error-message",o.style.cssText="\n            color: #dc3545;\n            font-size: 0.875rem;\n            margin-top: 0.5rem;\n            font-weight: 500;\n            display: block;\n            width: 100%;\n        ",o.textContent=t,n.parentNode.insertBefore(o,n.nextSibling)}}async function copyStandaloneUrl(){const e=document.getElementById("standaloneUrl"),t=e.value;try{navigator.clipboard&&window.isSecureContext?await navigator.clipboard.writeText(t):(e.select(),document.execCommand("copy"));const n=document.querySelector(".copy-url-btn"),o=n.textContent;n.textContent="Copied!",n.style.background="#28a745",setTimeout(()=>{n.textContent=o,n.style.background="#667eea"},2e3),showSuccessMessage("Card URL copied to clipboard!")}catch(e){console.error("Failed to copy URL:",e),showErrorMessage("Failed to copy URL. Please copy manually.")}}function updateAuthUI(){const e=document.getElementById("loginBtn"),t=document.getElementById("signupBtn"),n=document.getElementById("profileBtn"),o=document.getElementById("displayBtn"),a=document.getElementById("logoutBtn"),i=document.getElementById("faqBtn");i?.classList.remove("hidden"),currentUser?(e?.classList.add("hidden"),t?.classList.add("hidden"),n?.classList.remove("hidden"),o?.classList.remove("hidden"),a?.classList.remove("hidden")):(console.log("❌ User not authenticated"),e?.classList.remove("hidden"),t?.classList.remove("hidden"),n?.classList.add("hidden"),o?.classList.add("hidden"),a?.classList.add("hidden"))}async function logout(){try{await api.logout()&&($("#navbarAvatar").css("display","none"),showPage("home"),currentUser=null,userProfile=null,updateAuthUI(),showPage("home"),showSuccessMessage("Successfully logged out!"),$("#footer-cta").removeClass("display-none-cta-button"),$("#footer-cta").addClass("cta-section"),$("#singup-cta-button-div-uc").removeClass("display-none-cta-button"),$("#singup-cta-button-div-uc").addClass("usecase-cta"))}catch(e){console.error("Logout error:",e),showErrorMessage("Error logging out. Please try again.")}}function showLoadingMessage(e){const t=document.getElementById("loadingMessage");t&&t.remove();const n=document.createElement("div");n.id="loadingMessage",n.style.cssText="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: rgba(102, 126, 234, 0.95);\n        color: white;\n        padding: 2rem 3rem;\n        border-radius: 15px;\n        z-index: 2000;\n        font-weight: 600;\n        text-align: center;\n        backdrop-filter: blur(10px);\n        box-shadow: 0 20px 40px rgba(0,0,0,0.3);\n    ",n.innerHTML=`\n        <div style="margin-bottom: 1rem;">⏳</div>\n        <div>${e}</div>\n    `,document.body.appendChild(n)}function hideLoadingMessage(){const e=document.getElementById("loadingMessage");e&&e.remove()}$("#signupWithGoogle-btn").on("click",function(){signupWithGoogle()}),$("#singup-cta-button").on("click",function(){showPage("signup")}),$("#singup-cta-button-uc").on("click",function(){showPage("signup")}),$("#signupBtn").on("click",function(){showPage("signup")}),$("#faqBtn").on("click",function(){showPage("faq")}),$("#usecaseBtn").click(function(){showPage("usecase")}),$("#homepage-signup").on("click",function(){showPage("signup")}),$(".signupbutton").on("click",function(){showPage("signup")}),$(".homebutton").on("click",function(){showPage("home")}),$(".profilebutton").on("click",function(){showPage("home")}),$("#loginBtn").on("click",function(){showPage("login")}),$(".save-btn").on("click",function(){}),$("#qr-upload-div").on("click",function(){document.getElementById("qrUpload").click()}),$("#downloadVCard-btn").on("click",function(){downloadVCard()}),$("#shareCard-btn").on("click",function(){copyStandaloneUrl()}),$("#exportCard-btn").on("click",function(){exportCard()}),$("#addToWallet-btn").on("click",function(){addToWallet()}),$("#downloadQRCode-btn").on("click",function(){downloadStyledQRCard()}),$("#displayBtn").on("click",function(){showPage("display")}),$("#profileBtn").on("click",function(){showPage("profile")}),$("#logoutBtn").on("click",function(){logout()}),$("#googlesignin-button").on("click",function(){loginWithGoogle()}),$(document).on("click",".copy-url-btn",function(){copyStandaloneUrl()});const commonTLDs=["com","org","net","edu","gov","co","io","ai","app","dev","uk","us","ca","au","de","fr","in","me","info","biz","ly","it","es","ru","jp","cn","br","mx","id","ph","vn","tv","cc","ws","mobi","online","site","tech","store","xyz"],socialMediaPlatforms={instagram:{baseUrl:"https://instagram.com/",domains:["instagram.com"],handlePattern:/^@?[\w](?!.*?\.{2})[\w.]{0,28}[\w]$/},facebook:{baseUrl:"https://facebook.com/",domains:["facebook.com","fb.com"],handlePattern:/^@?[a-zA-Z0-9.]{3,}$/},twitter:{baseUrl:"https://twitter.com/",domains:["twitter.com","x.com"],handlePattern:/^@?[a-zA-Z0-9_]{1,15}$/},linkedin:{baseUrl:"https://linkedin.com/in/",domains:["linkedin.com"],handlePattern:/^[a-zA-Z0-9-]{3,100}$/},youtube:{baseUrl:"https://youtube.com/@",domains:["youtube.com","youtu.be"],handlePattern:/^@?[a-zA-Z0-9_-]{3,30}$/},tiktok:{baseUrl:"https://tiktok.com/@",domains:["tiktok.com"],handlePattern:/^@?[a-zA-Z0-9_.]{2,24}$/},snapchat:{baseUrl:"https://snapchat.com/add/",domains:["snapchat.com"],handlePattern:/^[a-zA-Z][a-zA-Z0-9._-]{1,15}$/},whatsapp:{baseUrl:"https://wa.me/",domains:["wa.me","whatsapp.com"],handlePattern:/^\+?[1-9]\d{1,14}$/},calendly:{baseUrl:"https://calendly.com/",domains:["calendly.com"],handlePattern:/^[a-zA-Z0-9-_]{3,30}$/},telegram:{baseUrl:"https://t.me/",domains:["t.me","telegram.com","telegram.me"],handlePattern:/^@?[a-zA-Z0-9_]{5,32}$/},reddit:{baseUrl:"https://reddit.com/u/",domains:["reddit.com"],handlePattern:/^(u\/)?[a-zA-Z0-9_-]{3,20}$/},pinterest:{baseUrl:"https://pinterest.com/",domains:["pinterest.com"],handlePattern:/^[a-zA-Z0-9_]{3,30}$/},zoom:{baseUrl:"",domains:["zoom.us","zoom.com"],handlePattern:null}};function isLikelyUrl(e){if(e.startsWith("http://")||e.startsWith("https://"))return!0;if(e.includes("/"))return!0;if(e.includes(".")){const t=e.split(".");if(t.length>2)return!0;if(2===t.length){const e=t[1].toLowerCase().split("/")[0];return!!commonTLDs.includes(e)}}return!1}function cleanHandle(e){return e.trim().replace(/^@+/,"")}function buildSocialUrl(e,t){const n=cleanHandle(t),o=socialMediaPlatforms[e];if(!o)return t;if("whatsapp"===e){const e=n.replace(/[^\d+]/g,"");return`${o.baseUrl}${e}`}return"reddit"!==e||n.startsWith("u/"),`${o.baseUrl}${n}`}function validateSocialMedia(e,t){if(!t||""===t.trim())return{valid:!0,url:""};const n=t.trim(),o=socialMediaPlatforms[e];if(!o)return{valid:!0,url:n};if(!isLikelyUrl(n)){if(o.handlePattern){const t=cleanHandle(n);return o.handlePattern.test(t)?{valid:!0,url:buildSocialUrl(e,n)}:{valid:!1,url:"",error:`Please enter a valid ${e} handle`}}return{valid:!0,url:buildSocialUrl(e,n)}}try{let t=n;t.startsWith("http://")||t.startsWith("https://")||(t="https://"+t);const a=new URL(t);return o.domains.some(e=>a.hostname.includes(e))?{valid:!0,url:t}:{valid:!1,url:"",error:`Please enter a valid ${e} URL or handle`}}catch(t){if(o.handlePattern){const t=cleanHandle(n);return o.handlePattern.test(t)?{valid:!0,url:buildSocialUrl(e,n)}:{valid:!1,url:"",error:`Please enter a valid ${e} handle or URL`}}return{valid:!0,url:buildSocialUrl(e,n)}}}function validateURL(e,t){const n=document.getElementById(e);if(!n)return!0;const o=n.value.trim();if(!o)return!0;if("website"===e)try{let e=o;return e.startsWith("http://")||e.startsWith("https://")||(e="https://"+e),new URL(e),n.setAttribute("data-final-url",e),!0}catch(n){return showError(e,t),!1}const a=validateSocialMedia(e,o);return a.valid?(n.setAttribute("data-final-url",a.url),!0):(showError(e,a.error||t),!1)}function testValidation(){[{platform:"instagram",value:"jhon.doe"},{platform:"instagram",value:"@john.smith"},{platform:"instagram",value:"test.user"},{platform:"instagram",value:"instagram.com/user"},{platform:"instagram",value:"https://instagram.com/user"},{platform:"instagram",value:"example.com"},{platform:"instagram",value:"site.io"}].forEach(e=>{validateSocialMedia(e.platform,e.value)})}async function handleProfileSave(){try{showLoadingMessage("Saving profile and generating QR codes...");const e=document.getElementById("profileForm");if(!e)throw new Error("Profile form not found");const t={};["instagram","facebook","twitter","linkedin","calendly","zoom","snapchat","tiktok","youtube","whatsapp","telegram","reddit","pinterest"].forEach(e=>{const n=document.getElementById(e);if(n){const o=n.getAttribute("data-final-url");o&&o.trim()&&(t[e]=o)}});const n=new FormData(e),o=locationAutocomplete?locationAutocomplete.getSelectedLocation():null,a={name:n.get("name"),title:n.get("title"),organization:n.get("organization"),phone:n.get("phone"),mobile:n.get("mobile"),email:n.get("email"),website:n.get("website"),address:n.get("address"),notes:n.get("notes"),showPhoneNumber:$("#showPhoneNumber").is(":checked"),country:{name:o?.country?.name||n.get("country")||"",code:n.get("countryCode")||o?.country?.code||""},state:{name:o?.state?.name||n.get("state")||"",id:n.get("stateId")||o?.state?.id||"",code:n.get("stateCode")||o?.state?.code||""},city:{name:o?.city?.name||n.get("city")||"",id:n.get("cityId")||o?.city?.id||""},socialMedia:t,isPublic:$("#isPublic").is(":checked")},i=await api.saveProfile(a);if(!i.success)throw new Error(i.message||"Save failed");{userProfile=i.profile;let e="Profile saved successfully!";i.qrGenerated&&(e+=` Generated ${i.qrCodes?.length||0} QR codes.`),showSuccessMessage(e),updateDisplayPage(),$(".profile-photo-section").show(),setTimeout(()=>{showPage("display")},1500)}}catch(e){console.error("Save profile error:",e),showErrorMessage("Failed to save profile: "+e.message)}finally{hideLoadingMessage()}}async function loadProfileData(){try{const e=await api.getProfile();if(e.success&&e.profile){userProfile=e.profile,document.getElementById("email").value=e.profile.email,void 0!==userProfile.showPhoneNumber&&(document.getElementById("showPhoneNumber").checked=userProfile.showPhoneNumber);const t=document.getElementById("profileForm");if(t&&t.querySelectorAll("input, textarea").forEach(e=>{const t=e.name;"country"!==t&&"state"!==t&&"city"!==t&&(t&&void 0!==userProfile[t]?e.value=userProfile[t]:t&&userProfile.socialMedia&&void 0!==userProfile.socialMedia[t]&&(e.value=userProfile.socialMedia[t]))}),userProfile.country?.name&&(document.getElementById("country").value=userProfile.country.name,document.getElementById("countryCode").value=userProfile.country.code||"",locationAutocomplete)){const e=locationAutocomplete.countries.find(e=>e.code===userProfile.country.code);e&&locationAutocomplete.selectCountry(e)}if(userProfile.state?.name&&setTimeout(()=>{if(document.getElementById("state").value=userProfile.state.name,document.getElementById("stateId").value=userProfile.state.id||"",document.getElementById("stateCode").value=userProfile.state.code||"",locationAutocomplete&&locationAutocomplete.selectedCountry){const e=locationAutocomplete.currentStates.find(e=>e.id===userProfile.state.id);e&&locationAutocomplete.selectState(e)}},500),userProfile.city?.name&&setTimeout(()=>{document.getElementById("city").value=userProfile.city.name,document.getElementById("cityId").value=userProfile.city.id||""},1e3),userProfile.uploadedQR&&userProfile.uploadedQR.url){const e=document.getElementById("qrPreview"),t=document.getElementById("qrUploadText");e&&t&&(e.src=api.baseURL+userProfile.uploadedQR.url,e.classList.remove("hidden"),t.innerHTML="QR Code uploaded ✅<br><small>Click to change</small>")}updateProfileDisplay(userProfile),updateNavbarAvatar(userProfile)}else if(e.success&&!e.profile){userProfile=null;const e=await api.getCurrentUser();1==e.success&&(document.getElementById("email").value=e.user.email)}else showPage("login")}catch(e){console.error("Load profile error:",e),e.message.includes("retrieving profile")?showErrorMessage("Unable to load your profile. Please try refreshing the page."):showErrorMessage("Profile loading error: "+e.message)}}function fallbackCopy(e,t,n){try{e.select(),e.setSelectionRange(0,99999),document.execCommand("copy"),showCopySuccess(t,n)}catch(e){showErrorMessage("Failed to copy URL. Please copy manually.")}}function showCopySuccess(e,t){e.textContent="✅ Copied!",e.style.background="#28a745",setTimeout(()=>{e.textContent=t,e.style.background="#667eea"},2e3),showSuccessMessage("Card URL copied to clipboard!")}function updateStandalonePage(){document.getElementById("standaloneName").textContent=userProfile.name,document.getElementById("standaloneTitle").textContent=userProfile.title,document.getElementById("standaloneOrganization").textContent=userProfile.organization,document.getElementById("standaloneEmail").textContent=userProfile.email,document.getElementById("standaloneAddress").textContent=userProfile.address,document.getElementById("standalonePhone").href=`tel:${userProfile.phone}`,document.getElementById("standalonePhone").querySelector("span:last-child").textContent=userProfile.phone,document.getElementById("standaloneMessage").href=`sms:${userProfile.mobile}`,document.getElementById("standaloneWebsiteLink").href=userProfile.website,document.getElementById("standaloneWebsite").textContent=userProfile.website.replace("https://","").replace("http://","");const e=document.getElementById("standaloneSocialLinks");e.innerHTML="";const t={instagram:"📷",facebook:"📘",twitter:"🐦",calendly:"📅",zoom:"💼",snapchat:"👻",tiktok:"🎵",linkedin:"💼"};Object.keys(userProfile.socialMedia).forEach(n=>{const o=userProfile.socialMedia[n];if(o){const a=document.createElement("a");a.className="standalone-social-item",a.href=o,a.target="_blank",a.innerHTML=`\n                <span class="social-icon">${t[n]}</span>\n                <span>${n}</span>\n            `,e.appendChild(a)}})}async function updateDisplayPage(){if(userProfile)try{const e=document.getElementById("socialLinksDisplay");e.innerHTML="",document.getElementById("displayName").textContent=userProfile.name,document.getElementById("displayTitle").textContent=userProfile.title,document.getElementById("displayOrganization").textContent=userProfile.organization,document.getElementById("displayEmail").textContent=userProfile.email,document.getElementById("displayAddress").textContent=userProfile.address,userProfile.mobile?($("#displayPhoneLink").attr("href",`tel:${userProfile.mobile}`).show(),$("#displayMessageLink").attr("href",`sms:${userProfile.mobile}`).show(),document.getElementById("displayPhoneLink").querySelector(".method-value").textContent=userProfile.mobile,document.getElementById("displayMessageLink").querySelector(".method-value").textContent=userProfile.mobile):($("#displayPhoneLink").hide(),$("#displayMessageLink").hide()),document.getElementById("displayEmailLink").href=`mailto:${userProfile.email}`,document.getElementById("displayEmail").textContent=userProfile.email,document.getElementById("displayWebsite").href=userProfile.website,document.getElementById("displayWebsite").querySelector(".method-value").textContent=userProfile.website.replace("https://","").replace("http://","");const t={instagram:'<i class="fab fa-instagram"></i>',facebook:'<i class="fab fa-facebook"></i>',twitter:'<i class="fab fa-twitter"></i>',linkedin:'<i class="fab fa-linkedin"></i>',calendly:'<i class="fas fa-calendar-alt"></i>',snapchat:'<i class="fab fa-snapchat"></i>',tiktok:'<i class="fab fa-tiktok"></i>',youtube:'<i class="fab fa-youtube"></i>',whatsapp:'<i class="fab fa-whatsapp"></i>',zoom:'<i class="fas fa-headphones"></i>',reddit:'<i class="fa-brands fa-reddit"></i>',telegram:'<i class="fa-brands fa-telegram"></i>',pinterest:'<i class="fa-brands fa-pinterest"></i>'};if(["instagram","facebook","twitter","linkedin","calendly","zoom","snapchat","tiktok","youtube","whatsapp","telegram","reddit","pinterest"].forEach(n=>{let o=userProfile.socialMedia&&userProfile.socialMedia[n];if(o&&"string"==typeof o&&o.trim()&&""!==o.trim()){const a=document.createElement("div");a.className="contact-detail",o.startsWith("http://")||o.startsWith("https://")||(o="https://"+o),a.innerHTML=`\n            <span>${t[n]||'<i class="fas fa-link"></i>'}</span>\n            <a href="${o}" target="_blank" class="contact-link" onclick="trackSocialClick('${n}')">${n.charAt(0).toUpperCase()+n.slice(1)}</a>\n        `,e.appendChild(a)}}),userProfile.cardId){const e=userProfile.slug||userProfile.cardId,t=`${window.location.origin}/card/${e}`,n=await api.getQRCode(e);document.getElementById("generatedQR").innerHTML=`\n                <img src="${n}" alt="QR Code" class="qr-preview" style="border-radius: 10px;">\n                <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Scan to view card</p>\n                \n                \x3c!-- Standalone URL section --\x3e\n                <div class="standalone-url-section" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">\n                    <h4 style="font-size: 0.9rem; color: #333; margin-bottom: 0.5rem;">📎 Share Your Card</h4>\n                    <div class="url-container" style="display: flex; align-items: center; gap: 0.5rem;">\n                        <input type="text" id="standaloneUrl" value="${t}" \n                               readonly style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; background: white; color: #333;">\n                        <button class="copy-url-btn" \n                                style="padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; white-space: nowrap;">\n                            📋 Copy\n                        </button>\n                    </div>\n                    <p style="font-size: 0.75rem; color: #666; margin-top: 0.5rem; margin-bottom: 0;">\n                        ${userProfile.slug?`Your personalized URL: /card/${userProfile.slug}`:"Share this link or QR code with others"}\n                    </p>\n                </div>\n            `}$("#navbarAvatar").show(),updateStandalonePage()}catch(e){console.error("Update display error:",e)}}async function trackSocialClick(e){userProfile&&userProfile.cardId&&await api.trackSocialClick(userProfile.cardId,e)}async function trackContactClick(e){userProfile&&userProfile.cardId&&await api.trackContactClick(userProfile.cardId,e)}async function downloadVCard(){try{userProfile&&userProfile.cardId&&(await api.downloadVCard(userProfile.cardId),showSuccessMessage("vCard download started!"))}catch(e){console.error("vCard download error:",e),showErrorMessage("Failed to download vCard")}}async function downloadQRCode(){try{if(userProfile&&userProfile.cardId){const e=userProfile.slug||userProfile.cardId,t=await api.getQRCode(e),n=document.createElement("a");n.href=t,n.download=`${userProfile.name}-QRCode.png`,document.body.appendChild(n),n.click(),document.body.removeChild(n),showSuccessMessage("QR Code downloaded!")}}catch(e){console.error("QR download error:",e),showErrorMessage("Failed to download QR code")}}async function downloadStyledQRCard(){try{if(userProfile&&(userProfile.slug||userProfile.cardId)){const e=userProfile.slug||userProfile.cardId,t=await api.getstyledQRCode(e),n=await fetch(t);if(!n.ok)throw new Error("Download failed");const o=await n.blob(),a=window.URL.createObjectURL(o),i=document.createElement("a");i.href=a,i.download=`${userProfile.name.replace(/\s+/g,"-")}-QR-Card.png`,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(a),showSuccessMessage("Styled QR Card downloaded!")}}catch(e){console.error("Styled QR card download error:",e),showErrorMessage("Failed to download styled QR card")}}function isAndroid(){return/Android/i.test(navigator.userAgent)}function isIOS(){return/iPad|iPhone|iPod/.test(navigator.userAgent)}function isIPad(){return/iPad/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1}function isIPhone(){return/iPhone/.test(navigator.userAgent)}function isDesktop(){return!(isIOS()||isIPad()||isAndroid()||/webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent))}function addToWallet(){const e={name:document.getElementById("displayName").textContent||"John Doe",phone:document.getElementById("displayPhoneLink").querySelector(".method-value").textContent||"",email:document.getElementById("displayEmail").textContent||"",website:document.getElementById("displayWebsite").querySelector(".method-value").textContent||"",qrCodeData:window.location.href};isIPhone()||isIPad()?generateAndSaveToWallet(e):isAndroid()?generateGoogleWalletPass(e):isDesktop()?downloadJSONAndShowPreview(e):createSimpleWalletPass(e)}function getPersonalizedUrl(){const e=document.getElementById("generatedQR");if(e){const t=e.querySelector("#standaloneUrl");if(t)return t.value}return window.location.href}function generateAndSaveToWallet(e){generatePassViaServer(createPassData(e),e,"apple")}function generateGoogleWalletPass(e){const t=createGoogleWalletData(e);"https:"===window.location.protocol?generatePassViaServer(t,e,"google"):createGoogleWalletUrl(e)}function createGoogleWalletData(e){return{iss:"your-service-account-email@your-project.iam.gserviceaccount.com",aud:"google",typ:"savetowallet",iat:Math.floor(Date.now()/1e3),payload:{genericObjects:[{id:`${generateSerialNumber()}`,classId:"your-issuer-id.digital_business_card_class",genericType:"GENERIC_TYPE_UNSPECIFIED",hexBackgroundColor:"#667eea",logo:{sourceUri:{uri:"https://your-domain.com/logo.png"},contentDescription:{defaultValue:{language:"en-US",value:"QRprofile Logo"}}},cardTitle:{defaultValue:{language:"en-US",value:"Digital Business Card"}},subheader:{defaultValue:{language:"en-US",value:e.name}},header:{defaultValue:{language:"en-US",value:e.email}},textModulesData:[{id:"phone",header:"Phone",body:e.phone},{id:"website",header:"Website",body:e.website}],linksModuleData:{uris:[{uri:e.qrCodeData,description:"View Profile",id:"profile_link"}]},barcode:{type:"QR_CODE",value:e.qrCodeData,alternateText:"Scan to view profile"}}]}}}function createGoogleWalletUrl(e){const t=createVCard(e);encodeURIComponent(t),e.name,e.email,e.phone,e.website,e.qrCodeData,showGoogleWalletInstructions(e)}function createVCard(e){return`BEGIN:VCARD\nVERSION:3.0\nFN:${e.name}\nTEL:${e.phone}\nEMAIL:${e.email}\nURL:${e.website}\nNOTE:${e.qrCodeData}\nEND:VCARD`}function createApplePassData(e){return{formatVersion:1,passTypeIdentifier:"pass.com.qrprofiler.digitalcard",serialNumber:generateSerialNumber(),organizationName:"Digital QR Profiler",description:"Digital Business Card",logoText:"QRprofile",foregroundColor:"rgb(255, 255, 255)",backgroundColor:"rgb(102, 126, 234)",labelColor:"rgb(255, 255, 255)",generic:{primaryFields:[{key:"name",label:"Name",value:e.name}],secondaryFields:[{key:"phone",label:"Phone",value:e.phone},{key:"email",label:"Email",value:e.email}],auxiliaryFields:e.website?[{key:"website",label:"Website",value:e.website}]:[],backFields:[{key:"qr_info",label:"QR Code",value:"Scan to view full profile"},{key:"profile_link",label:"Profile Link",value:e.qrCodeData}]},barcode:{message:e.qrCodeData,format:"PKBarcodeFormatQR",messageEncoding:"iso-8859-1"}}}function downloadBothFormatsAndShowPreview(e){downloadPassJSON(createApplePassData(e),e,"apple"),downloadPassJSON(createGoogleWalletData(e),e,"google"),setTimeout(()=>{createSimpleWalletPass(e)},500),showDesktopInstructions()}function downloadJSONAndShowPreview(e){downloadPassJSON(createPassData(e),e),setTimeout(()=>{createSimpleWalletPass(e)},500),showDesktopInstructions()}function createPassData(e){return{formatVersion:1,passTypeIdentifier:"pass.com.qrprofiler.digitalcard",serialNumber:generateSerialNumber(),teamIdentifier:"YOUR_TEAM_ID",webServiceURL:"",authenticationToken:generateAuthToken(),organizationName:"Digital QR Profiler",description:"Digital Business Card",logoText:"QRprofile",foregroundColor:"rgb(255, 255, 255)",backgroundColor:"rgb(102, 126, 234)",labelColor:"rgb(255, 255, 255)",generic:{primaryFields:[{key:"name",label:"Name",value:e.name}],secondaryFields:[{key:"phone",label:"Phone",value:e.phone},{key:"email",label:"Email",value:e.email}],auxiliaryFields:e.website?[{key:"website",label:"Website",value:e.website}]:[],backFields:[{key:"qr_info",label:"QR Code",value:"Scan to view full profile"},{key:"profile_link",label:"Profile Link",value:e.qrCodeData}]},barcode:{message:e.qrCodeData,format:"PKBarcodeFormatQR",messageEncoding:"iso-8859-1"},barcodes:[{message:e.qrCodeData,format:"PKBarcodeFormatQR",messageEncoding:"iso-8859-1"}]}}function downloadPassJSON(e,t,n){const o=JSON.stringify(e,null,2),a=new Blob([o],{type:"application/json"}),i=URL.createObjectURL(a),s=document.createElement("a");s.href=i,s.download=`${t.name.replace(/\s+/g,"_")}_${n}_wallet_pass.json`,s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}async function generatePassViaServer(e,t,n){showLoadingIndicator();const o=`/api/card/${userProfile.slug}/apple-wallet-pass`,a="apple"===n?o:"/api/generate-google-pass";try{const e=await fetch(a,{method:"GET",headers:{Accept:"application/vnd.apple.pkpass, application/octet-stream"}});if(hideLoadingIndicator(),!e.ok)throw new Error(`Failed to generate ${n} wallet pass: ${e.statusText}`);const o=window.location.origin+a;if("apple"===n&&isIOS())return;if("google"===n&&isAndroid()){const e=`https://pay.google.com/gp/v/save/${o}`;window.location.href=e}else{const e=document.createElement("a");e.href=o,e.download=`${t.name.replace(/\s+/g,"_")}.${"apple"===n?"pkpass":"gwpass"}`,e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}}catch(e){hideLoadingIndicator(),console.error(`Error generating ${n} wallet pass:`,e),"apple"===n?showIOSInstructions(t):showGoogleWalletInstructions(t)}}function createSimpleWalletPass(e){const t=document.getElementById("generatedQR");let n="",o="";if(t){const a=t.querySelector("img");n=a?`<img src="${a.src}" style="width: 60px; height: 60px; border-radius: 8px;">`:'<div style="width: 50px; height: 50px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #333; font-size: 12px;">QR</div>';const i=t.querySelector("#standaloneUrl");o=i?i.value:e.qrCodeData}else n='<div style="width: 50px; height: 50px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #333; font-size: 12px;">QR</div>',o=e.qrCodeData;const a=`\n    <!DOCTYPE html>\n    <html>\n    <head>\n        <meta charset="UTF-8">\n        <meta name="viewport" content="width=device-width, initial-scale=1.0">\n        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">\n        <title>Digital Business Card - ${e.name}</title>\n        <style>\n            body {\n                margin: 0;\n                padding: 20px;\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                background: #f0f0f0;\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n                align-items: center;\n                min-height: 100vh;\n            }\n            .wallet-pass {\n                width: 340px;\n                max-width: 90vw;\n                height: 220px;\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                border-radius: 15px;\n                color: white;\n                padding: 20px;\n                box-shadow: 0 10px 30px rgba(0,0,0,0.3);\n                position: relative;\n                overflow: hidden;\n                margin-bottom: 20px;\n            }\n            .pass-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                margin-bottom: 15px;\n            }\n            img.logo-image-only {\n                height: 20px;\n                width: auto;\n                background: white;\n                padding: 4px;\n                border-radius: 4px;\n            }\n            .logo {\n                font-weight: bold;\n                font-size: 16px;\n            }\n            .qr-code {\n                width: 70px;\n                height: 70px;\n                background: white;\n                border-radius: 8px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                overflow: hidden;\n            }\n            .pass-content h1 {\n                font-size: 20px;\n                margin: 0 0 10px 0;\n                font-weight: 500;\n            }\n            .pass-content p {\n                margin: 3px 0;\n                font-size: 14px;\n                opacity: 0.9;\n            }\n            .barcode-area {\n                position: absolute;\n                bottom: 15px;\n                right: 20px;\n                font-size: 12px;\n                opacity: 0.7;\n            }\n            .instructions {\n                background: white;\n                padding: 20px;\n                border-radius: 15px;\n                max-width: 90vw;\n                width: 400px;\n                text-align: center;\n                box-shadow: 0 5px 15px rgba(0,0,0,0.1);\n            }\n            .device-info {\n                background: #667eea;\n                color: white;\n                padding: 10px 15px;\n                border-radius: 20px;\n                font-size: 14px;\n                margin-bottom: 15px;\n                display: inline-block;\n            }\n            .url-section {\n                background: #f8f9fa;\n                padding: 15px;\n                border-radius: 10px;\n                margin-top: 15px;\n                text-align: left;\n            }\n            .url-section h4 {\n                margin: 0 0 10px 0;\n                font-size: 14px;\n                color: #333;\n            }\n            .url-display {\n                background: white;\n                padding: 10px;\n                border-radius: 6px;\n                border: 1px solid #ddd;\n                word-break: break-all;\n                font-size: 12px;\n                color: #666;\n                font-family: monospace;\n            }\n            .clickable {\n                cursor: pointer;\n                transition: background-color 0.2s;\n            }\n            .clickable:hover {\n                background-color: #e9ecef;\n            }\n        </style>\n    </head>\n    <body>\n        <div class="wallet-pass">\n            <div class="pass-header">\n                <img src="./image/app-logo.png" alt="QRprofile Logo" class="logo-image-only">\n                <div class="qr-code">\n                    ${n}\n                </div>\n            </div>\n            <div class="pass-content">\n                <h1>${e.name}</h1>\n                <p>${e.phone}</p>\n                <p>${e.email}</p>\n                ${e.website?`<p>${e.website}</p>`:""}\n            </div>\n            <div class="barcode-area">\n                Scan to connect\n            </div>\n        </div>\n        \n        <div class="instructions">\n            <div class="device-info">\n                Device: ${navigator.userAgent.includes("iPhone")?"iPhone":navigator.userAgent.includes("iPad")?"iPad":"Desktop"}\n            </div>\n            <h3>Digital Business Card Preview</h3>\n            <p>This is how your card will appear in Apple Wallet. ${isDesktop()?"The JSON file has been downloaded to your computer.":"Tap the QR code to share your profile."}</p>\n            \n            <div class="url-section">\n                <h4>📎 Share Your Card</h4>\n                <div class="url-display clickable" onclick="copyToClipboard('${o}')">\n                    ${o}\n                </div>\n                <p style="font-size: 12px; color: #666; margin: 8px 0 0 0;">\n                    Click to copy link\n                </p>\n            </div>\n        </div>\n        \n        <script>\n            function copyToClipboard(text) {\n                if (navigator.clipboard) {\n                    navigator.clipboard.writeText(text).then(function() {\n                        showCopyFeedback();\n                    }).catch(function(err) {\n                        console.error('Could not copy text: ', err);\n                        fallbackCopyTextToClipboard(text);\n                    });\n                } else {\n                    fallbackCopyTextToClipboard(text);\n                }\n            }\n            \n            function fallbackCopyTextToClipboard(text) {\n                var textArea = document.createElement("textarea");\n                textArea.value = text;\n                textArea.style.position = "fixed";\n                textArea.style.top = "-999px";\n                textArea.style.left = "-999px";\n                document.body.appendChild(textArea);\n                textArea.focus();\n                textArea.select();\n                \n                try {\n                    var successful = document.execCommand('copy');\n                    if (successful) {\n                        showCopyFeedback();\n                    }\n                } catch (err) {\n                    console.error('Fallback: Could not copy text: ', err);\n                }\n                \n                document.body.removeChild(textArea);\n            }\n            \n            function showCopyFeedback() {\n                var urlDisplay = document.querySelector('.url-display');\n                var originalText = urlDisplay.innerHTML;\n                urlDisplay.innerHTML = '✅ Copied to clipboard!';\n                urlDisplay.style.backgroundColor = '#d4edda';\n                urlDisplay.style.color = '#155724';\n                \n                setTimeout(function() {\n                    urlDisplay.innerHTML = originalText;\n                    urlDisplay.style.backgroundColor = '';\n                    urlDisplay.style.color = '';\n                }, 2000);\n            }\n        <\/script>\n    </body>\n    </html>`,i=window.open();i.document.write(a),i.document.close()}function showLoadingIndicator(){const e=document.createElement("div");e.id="wallet-loader",e.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.8);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 10000;\n        color: white;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    ",e.innerHTML='\n        <div style="text-align: center;">\n            <div style="width: 40px; height: 40px; border: 3px solid #667eea; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>\n            <p>Generating wallet pass...</p>\n        </div>\n        <style>\n            @keyframes spin {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n            }\n        </style>\n    ',document.body.appendChild(e)}function hideLoadingIndicator(){const e=document.getElementById("wallet-loader");e&&e.remove()}function showIOSInstructions(e){showModal('\n        <h2>Add to Apple Wallet</h2>\n        <p>To add this business card to your Apple Wallet:</p>\n        <ol style="text-align: left; margin: 20px 0;">\n            <li>A wallet pass file will be generated</li>\n            <li>Tap "Add" when prompted</li>\n            <li>The card will appear in your Wallet app</li>\n        </ol>\n        <p style="font-size: 14px; color: #666;">\n            Note: This requires a configured wallet pass service\n        </p>\n    ')}function showDesktopInstructions(){showModal('\n        <h2>Wallet Pass Generated</h2>\n        <p>A JSON file has been downloaded and a preview opened in a new window.</p>\n        <div style="background: #f8f9ff; padding: 15px; border-radius: 10px; margin: 15px 0;">\n            <h4 style="margin: 0 0 10px 0; color: #667eea;">To create Apple Wallet pass:</h4>\n            <ol style="text-align: left; font-size: 14px;">\n                <li>Upload the JSON file to a wallet pass service</li>\n                <li>Download the generated .pkpass file</li>\n                <li>Transfer to iPhone and open</li>\n                <li>Add to Apple Wallet</li>\n            </ol>\n        </div>\n    ')}function showGoogleWalletInstructions(e){showModal('\n        <h2>Add to Google Wallet</h2>\n        <p>To add this business card to your Google Wallet:</p>\n        <ol style="text-align: left; margin: 20px 0;">\n            <li>A Google Wallet pass will be generated</li>\n            <li>Tap "Add to Google Wallet" when prompted</li>\n            <li>The card will appear in your Google Wallet app</li>\n        </ol>\n        <p style="font-size: 14px; color: #666;">\n            Note: This requires Google Wallet pass configuration\n        </p>\n    ')}function showDesktopInstructions(){showModal('\n        <h2>Wallet Passes Generated</h2>\n        <p>JSON files for both Apple Wallet and Google Wallet have been downloaded.</p>\n        <div style="background: #f8f9ff; padding: 15px; border-radius: 10px; margin: 15px 0;">\n            <h4 style="margin: 0 0 10px 0; color: #667eea;">Apple Wallet (iOS):</h4>\n            <ol style="text-align: left; font-size: 14px; margin-bottom: 15px;">\n                <li>Process the Apple JSON file through a .pkpass generator</li>\n                <li>Transfer to iPhone and open the .pkpass file</li>\n                <li>Add to Apple Wallet</li>\n            </ol>\n            \n            <h4 style="margin: 0 0 10px 0; color: #667eea;">Google Wallet (Android):</h4>\n            <ol style="text-align: left; font-size: 14px;">\n                <li>Process the Google JSON file through Google Wallet API</li>\n                <li>Generate a Google Wallet save link</li>\n                <li>Open link on Android device</li>\n                <li>Add to Google Wallet</li>\n            </ol>\n        </div>\n    ')}function showModal(e){const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.8);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 10000;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    ";const n=document.createElement("div");n.style.cssText="\n        background: white;\n        padding: 30px;\n        border-radius: 20px;\n        max-width: 90%;\n        max-width: 500px;\n        text-align: center;\n        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);\n    ",n.innerHTML=e+'\n        <button id="closeModalBtn" \n                style="background: #667eea; color: white; border: none; padding: 10px 20px; \n                       border-radius: 10px; cursor: pointer; font-size: 16px; margin-top: 20px;">\n            Got it!\n        </button>\n    ',t.appendChild(n),document.body.appendChild(t),document.getElementById("closeModalBtn").addEventListener("click",function(){t.remove()})}function generateSerialNumber(){return"QRP-"+Date.now()+"-"+Math.random().toString(36).substr(2,9)}function generateAuthToken(){return"auth-"+Math.random().toString(36).substr(2,15)}async function handleQRUpload(e){const t=e.target.files[0];if(t)try{const e=await api.uploadQRCode(t);if(!e.success)throw new Error(e.message);document.getElementById("qrPreview").src=api.baseURL+e.qrUrl,document.getElementById("qrPreview").classList.remove("hidden"),document.getElementById("qrUploadText").innerHTML="QR Code uploaded ✅<br><small>Click to change</small>",showSuccessMessage("QR Code uploaded successfully!")}catch(e){console.error("QR upload error:",e),showErrorMessage("Failed to upload QR code: "+e.message)}}async function loadStandaloneCard(){const e=new URLSearchParams(window.location.search).get("card");if(e)try{const t=await api.getPublicCard(e);if(t.success)return updateStandalonePageWithData(t.card),!0}catch(e){console.error("Load standalone card error:",e),document.getElementById("standalonePage").innerHTML='\n        <div style="text-align: center; padding: 3rem;">\n          <h2>Card Not Found</h2>\n          <p>The requested business card could not be found or is not public.</p>\n          <button onclick="window.location.href=\'/\'" class="standalone-btn">Go Home</button>\n        </div>\n      '}return!1}function updateStandalonePageWithData(e){document.getElementById("standaloneName").textContent=e.name,document.getElementById("standaloneTitle").textContent=e.title,document.getElementById("standaloneOrganization").textContent=e.organization,document.getElementById("standaloneEmail").textContent=e.email,document.getElementById("standaloneAddress").textContent=e.address,document.getElementById("standalonePhone").href=`tel:${e.phone}`,document.getElementById("standalonePhone").querySelector("span:last-child").textContent=e.phone,document.getElementById("standaloneMessage").href=`sms:${e.mobile}`,document.getElementById("standaloneWebsiteLink").href=e.website,document.getElementById("standaloneWebsite").textContent=e.website.replace("https://","").replace("http://","");const t=document.getElementById("standaloneSocialLinks");t.innerHTML="";const n={instagram:"📷",facebook:"📘",twitter:"🐦",linkedin:"💼",calendly:"📅",zoom:"💼",snapchat:"👻",tiktok:"🎵"};Object.keys(e.socialMedia||{}).forEach(o=>{const a=e.socialMedia[o];if(a){const i=document.createElement("a");i.className="standalone-social-item",i.href=a,i.target="_blank",i.onclick=()=>api.trackSocialClick(e.cardId,o),i.innerHTML=`\n        <span class="social-icon">${n[o]}</span>\n        <span>${o}</span>\n      `,t.appendChild(i)}}),window.currentCardData=e}function showSuccessMessage(e){const t=document.createElement("div");t.style.cssText="\n    position: fixed;\n    bottom: 2rem;\n    right: 2rem;\n    background: #28a745;\n    color: white;\n    padding: 1rem 1.5rem;\n    border-radius: 10px;\n    z-index: 1001;\n    font-weight: 600;\n    box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);\n    animation: slideInUp 0.3s ease;\n  ",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutDown 0.3s ease forwards",setTimeout(()=>t.remove(),300)},300)}function showErrorMessage(e){const t=document.createElement("div");t.style.cssText="\n    position: fixed;\n    bottom: 2rem;\n    right: 2rem;\n    background: #dc3545;\n    color: white;\n    padding: 1rem 1.5rem;\n    border-radius: 10px;\n    z-index: 1001;\n    font-weight: 600;\n    box-shadow: 0 10px 25px rgba(220, 53, 69, 0.3);\n  ",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),4e3)}async function checkStandaloneMode(){return!!new URLSearchParams(window.location.search).get("card")&&(document.querySelector(".navbar").style.display="none",document.getElementById("standalonePage").style.display="flex",document.querySelectorAll(".page:not(#standalonePage)").forEach(e=>{e.style.display="none"}),await loadStandaloneCard())}async function showPage(e){if(await checkStandaloneMode())return;if(!currentUser&&("profile"===e||"display"===e))return showPage("home"),void showErrorMessage("Please log in to access this page");document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active"),e.style.display="none"});const t=document.getElementById(e+"Page");t&&(t.classList.add("active"),t.style.display="block","profile"===e?loadProfileData():"display"===e&&updateDisplayPage())}function setUserEmail(e){const t=document.getElementById("email");t&&(t.value=e,t.setAttribute("readonly",!0),t.style.backgroundColor="#f8f9fa",t.style.cursor="not-allowed",t.style.color="#6c757d")}function updateProfileDisplay(e){const t=$("#avatarDisplay"),n=$("#avatarInitials"),o=$("#profilePhotoImg"),a=$("#deletePhotoBtn");e.hasProfilePhoto?(o.attr("src",`/api/profile/photo/${e._id}`),o.show(),t.hide(),a.show()):(n.text(e.initials),t.show(),o.hide(),a.hide())}function updateNavbarAvatar(e){let t=$(".navbar-avatar");0===t.length&&(t=$('<div class="navbar-avatar"></div>'),$("#logoutBtn").after(t)),t.empty(),e.hasProfilePhoto?t.html(`<img src="/api/profile/photo/${e._id}" alt="Profile">`):t.text(e.initials),t.off("click").on("click",function(){})}async function uploadProfilePhoto(e){const t=new FormData;t.append("profilePhoto",e);const n=e.name.toLowerCase().endsWith(".heic")||e.name.toLowerCase().endsWith(".heif"),o=$("#uploadPhotoBtn");o.prop("disabled",!0).text(n?"Converting & Uploading...":"Uploading...");try{const e=await $.ajax({url:"/api/profile/upload-profile-photo",method:"POST",data:t,processData:!1,contentType:!1,headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(console.log("Profile response: ",e),e.success){alert("Profile photo uploaded successfully!"),$("#deletePhotoBtn").show();const e=' <i class="fas fa-upload"></i>\n            Upload Photo';o.prop("disabled",!1).html(e),await loadProfileData()}}catch(e){console.error("Error uploading photo:",e),alert(e.responseJSON?.message||"Error uploading photo"),$("#profilePhotoImg").hide(),$("#avatarDisplay").show(),$("#profilePhotoInput").val("")}}async function getUserStatus(){try{return await $.ajax({url:"auth/status",method:"GET",dataType:"json"})}catch(e){console.log("Failed to fetch user:",e.message)}}async function handleURLParams(){const e=new URLSearchParams(window.location.search);if(e.toString()){const t={};for(const[n,o]of e.entries())t[n]=o;if(console.log("Parameters:",t),e.has("page")){console.log("Page:",e.get("page"));let t=e.get("page");if("home"==t&&showPage("home"),"faq"==t&&showPage("faq"),"usecase"==t&&showPage("usecase"),"scenario"==t&&showPage("usecase"),"signup"==t){const e=await getUserStatus();e&&e.authenticated&&1==e.authenticated?showPage("display"):showPage("signup")}if("login"==t){const e=await getUserStatus();e&&e.authenticated&&1==e.authenticated?showPage("display"):showPage("login")}if("profile"==t){const e=await getUserStatus();e&&e.authenticated&&1==e.authenticated?showPage("display"):showPage("login")}}return t}return showPage("home"),console.log("No URL parameters found"),null}$(document).ready(function(){function e(){const e=document.querySelector(".navbar"),t=document.querySelector(".container");window.innerWidth<330?(e.style.display="none",t.style.display="none",function(){const e=document.getElementById("resolution-message");e&&e.remove();const t=document.createElement("div");t.id="resolution-message",t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 9999;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    ";const n=document.createElement("div");n.style.cssText="\n        background: white;\n        padding: 2rem;\n        border-radius: 20px;\n        text-align: center;\n        max-width: 90%;\n        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);\n    ",n.innerHTML=`\n        <div style="font-size: 3rem; margin-bottom: 1rem;">📱</div>\n        <h2 style="color: #333; margin-bottom: 1rem; font-size: 1.5rem;">Screen Too Small</h2>\n        <p style="color: #666; margin-bottom: 1.5rem; line-height: 1.5;">\n            This application requires a minimum screen width of 400px for the best experience. \n            Please rotate your device or use a larger screen.\n        </p>\n        <p style="color: #999; font-size: 0.9rem;">\n            Current width: ${window.innerWidth}px | Required: 400px minimum\n        </p>\n    `,t.appendChild(n),document.body.appendChild(t)}()):(e.style.display="flex",t.style.display="block",function(){const e=document.getElementById("resolution-message");e&&e.remove()}())}function t(){document.querySelectorAll("#profileForm input, #profileForm textarea").forEach(e=>{e.style.borderColor="",e.style.backgroundColor=""}),document.querySelectorAll(".input-error").forEach(e=>{e.innerHTML=""}),document.querySelectorAll(".error-message").forEach(e=>e.remove());let e=!0;e=n("name","Full name is required")&&e,e=n("email","Email address is required")&&e;const t=document.getElementById("phone").value.trim(),a=document.getElementById("mobile").value.trim();return t&&(e=o("phone")&&e),a&&(e=o("mobile")&&e),document.getElementById("website").value.trim()&&(e=validateURL("website","Please enter a valid website URL")&&e),["instagram","facebook","twitter","linkedin","calendly","zoom","snapchat","tiktok","youtube","whatsapp","pinterest"].forEach(t=>{document.getElementById(t).value.trim()&&(e=validateURL(t,`Please enter a valid ${t} URLlll`)&&e)}),e}function n(e,t){return!!document.getElementById(e).value.trim()||(showError(e,t),!1)}function o(e){const t=document.getElementById(e).value.trim();return!t||!!/^\d{10}$/.test(t)||(showError(e,"Please enter exactly 10 digits"),!1)}$("#isPublic").on("change",function(){const e=$(this).is(":checked"),t=$(this).closest(".form-group").find(".form-text");e?(t.text("When checked, others can view your card using the link or QR code"),t.removeClass("text-danger").addClass("text-muted")):(t.text("Your card will be private - only you can access it when logged in"),t.removeClass("text-muted").addClass("text-danger"))}),document.addEventListener("DOMContentLoaded",e),window.addEventListener("resize",e),document.addEventListener("DOMContentLoaded",function(){document.querySelector(".save-btn"),function(){const e=document.getElementById("profileForm");e.addEventListener("input",function(e){setTimeout(()=>{t()},100)}),e.addEventListener("blur",function(e){const a=e.target.id;if(!a)return;const i=["instagram","facebook","twitter","linkedin","calendly","zoom","snapchat","tiktok","youtube","whatsapp","telegram","reddit","pinterest"];if(i.includes(a)){const t=e.target.closest(".social-item").querySelector(".input-error");t&&(t.innerHTML="")}else{const t=e.target.parentNode.querySelector(".error-message");t&&t.remove()}e.target.style.borderColor="",e.target.style.backgroundColor="";let s=!0;const r=e.target.value.trim();switch(a){case"name":case"email":s=n(a,`${a.charAt(0).toUpperCase()+a.slice(1)} is required`);break;case"phone":case"mobile":r&&(s=o(a));break;case"website":r&&(s=validateURL("website","Please enter a valid website URL"));break;default:i.includes(a)&&r&&(s=validateURL(a,`Please enter a valid ${a} URLaaaaa`))}setTimeout(()=>{t()},50)},!0)}()}),document.getElementById("profileForm").addEventListener("submit",function(e){e.preventDefault(),t()}),document.querySelector(".save-btn").addEventListener("click",function(e){if(e.preventDefault(),t()){const e=this,t=e.textContent;e.textContent="Saved!",e.style.backgroundColor="#28a745",handleProfileSave(),setTimeout(()=>{e.textContent=t,e.style.backgroundColor=""},2e3)}})}),document.addEventListener("DOMContentLoaded",function(){const e={privacy:document.getElementById("privacy-modal"),terms:document.getElementById("terms-modal"),faq:document.getElementById("faq-modal"),suggestions:document.getElementById("suggestions-modal"),contact:document.getElementById("contact-modal")},t={privacy:document.getElementById("privacy-link"),terms:document.getElementById("terms-link"),faq:document.getElementById("faq-link"),suggestions:document.getElementById("suggestions-link"),contact:document.getElementById("contact-link")};Object.keys(t).forEach(n=>{t[n]&&t[n].addEventListener("click",t=>{var o;t.preventDefault(),e[o=n]&&(e[o].style.display="block",document.body.style.overflow="hidden")})}),document.querySelectorAll(".close").forEach(t=>{t&&t.addEventListener("click",()=>{Object.keys(e).forEach(t=>{var n;e[t]&&"block"===e[t].style.display&&e[n=t]&&(e[n].style.display="none",document.body.style.overflow="auto")})})}),Object.values(e).forEach(e=>{e&&e.addEventListener("click",t=>{t.target===e&&(e.style.display="none",document.body.style.overflow="auto")})}),document.querySelectorAll(".faq-question").forEach(e=>{e&&e.addEventListener("click",()=>{const t=e.nextElementSibling;if(t){const e=t.classList.contains("show");document.querySelectorAll(".faq-answer").forEach(e=>{e.classList.remove("show")}),e||t.classList.add("show")}})});const n=document.getElementById("suggestions-form");n&&n.addEventListener("submit",async function(e){e.preventDefault();const t=new FormData(this),n={name:t.get("name"),email:t.get("email"),category:t.get("category"),title:t.get("title"),details:t.get("details")},o=this.querySelector('button[type="submit"]'),r=o.innerHTML;if(!n.name||n.name.trim().length<2)alert("Please enter a valid name (at least 2 characters)");else if(n.email&&a(n.email))if(!n.title||n.title.trim().length<5)alert("Please enter a suggestion title (at least 5 characters)");else if(!n.details||n.details.trim().length<5)alert("Please provide more details (at least 20 characters)");else{o.innerHTML='<i class="fas fa-spinner fa-spin"></i> Submitting...',o.disabled=!0;try{const e=await api.updatesuggestions(n);if(!e||!e.success)throw s("Failed to submit suggestion"),new Error(e.message||"Failed to submit suggestion");{i(e.message),this.reset();const t=this.closest(".modal");t&&(t.style.display="none",document.body.style.overflow="auto")}}catch(e){console.error("Suggestion submission error:",e);let t="There was an error submitting your suggestion. ";e.message.includes("fetch")?(t+="Please check your internet connection and try again.",s(t)):e.message.includes("similar suggestion")?(t="A similar suggestion was already submitted recently. Please try a different suggestion.",s(t)):(t+=e.message||"Please try again later.",s(t))}finally{o.innerHTML=r,o.disabled=!1}}else alert("Please enter a valid email address")});const o=document.querySelector(".footer-section:last-child .btn");function a(e){return/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/.test(e)}function i(e){const t=document.createElement("div");t.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: #d4edda;\n            color: #155724;\n            padding: 15px 20px;\n            border-radius: 8px;\n            border: 1px solid #c3e6cb;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n            z-index: 10000;\n            max-width: 400px;\n            font-size: 14px;\n        ",t.innerHTML=`<i class="fas fa-check-circle"></i> ${e}`,document.body.appendChild(t),setTimeout(()=>{t.remove()},5e3)}function s(e){const t=document.createElement("div");t.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: #f8d7da;\n            color: #721c24;\n            padding: 15px 20px;\n            border-radius: 8px;\n            border: 1px solid #f5c6cb;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n            z-index: 10000;\n            max-width: 400px;\n            font-size: 14px;\n        ",t.innerHTML=`<i class="fas fa-exclamation-triangle"></i> ${e}`,document.body.appendChild(t),setTimeout(()=>{t.remove()},5e3)}o&&o.addEventListener("click",function(e){e.preventDefault();const t=this.previousElementSibling;t&&t.value&&(alert("Thank you for subscribing to our newsletter!"),t.value="")});const r=document.getElementById("contact-form");r&&r.addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("contact-success");t&&(t.style.display="none");const n=new FormData(this),o={name:n.get("name"),email:n.get("email"),phone:n.get("phone"),subject:n.get("subject"),message:n.get("message")},r=this.querySelector('button[type="submit"]'),l=r.innerHTML,c=!(d=o).name||d.name.trim().length<2?"Please enter a valid name (at least 2 characters)":d.email&&a(d.email)?d.subject?!d.message||d.message.trim().length<10?"Please enter a message (at least 10 characters)":d.phone&&d.phone.trim()&&(u=d.phone,!/^[\+]?[1-9][\d]{0,15}$/.test(u.trim()))?"Please enter a valid phone number or leave it empty":null:"Please select a subject":"Please enter a valid email address";var d,u;if(c)s(c);else{r.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sending...',r.disabled=!0;try{const e=await api.updatecontactinfo(o);if(!e||!e.success)throw s("Failed to send message"),new Error(e.message||"Failed to send message");i("Thank you for contacting us. We will get back to you."),this.reset(),setTimeout(()=>{const e=document.getElementById("contact-modal");e&&(e.style.display="none",document.body.style.overflow="auto"),t&&(t.style.display="none")},3e3)}catch(e){console.error("Contact submission error:",e);let t="There was an error sending your message. ";e.message.includes("fetch")||e.message.includes("NetworkError")?(t+="Please check your internet connection and try again.",s(t)):e.message.includes("validation")||e.message.includes("required")?(t="Please fill in all required fields correctly.",s(t)):(t+=e.message||"Please try again later.",s(t))}finally{r.innerHTML=l,r.disabled=!1}}});const l=document.getElementById("contact-modal"),c=l?.querySelector(".close");c&&c.addEventListener("click",function(){l.style.display="none",document.body.style.overflow="auto";const e=document.getElementById("contact-success");e&&(e.style.display="none")}),l&&l.addEventListener("click",function(e){if(e.target===l){l.style.display="none",document.body.style.overflow="auto";const e=document.getElementById("contact-success");e&&(e.style.display="none")}})}),$("#uploadPhotoBtn").on("click",function(){$("#profilePhotoInput").click()}),$("#profilePhotoInput").on("change",async function(e){const t=e.target.files[0];if(!t)return;if(t.size>5242880)return alert("File size must be less than 5MB"),void $(this).val("");const n=t.name.toLowerCase(),o=n.endsWith(".heic")||n.endsWith(".heif"),a=t.type.startsWith("image/");if(!t.type.startsWith("image/"))return alert("Please select an image file"),void $(this).val("");if(!a&&!o)return alert("Please select an image file (JPG, PNG, GIF, HEIC)"),void $(this).val("");if(o)console.log("📸 HEIC file - will be converted on server"),$("#avatarDisplay").show(),$("#profilePhotoImg").hide();else{const e=new FileReader;e.onload=function(e){$("#profilePhotoImg").attr("src",e.target.result).show(),$("#avatarDisplay").hide()},e.readAsDataURL(t)}await uploadProfilePhoto(t)}),$("#deletePhotoBtn").on("click",async function(){if(confirm("Are you sure you want to remove your profile photo?"))try{(await $.ajax({url:"/api/profile/delete-profile-photo",method:"DELETE",headers:{Authorization:"Bearer "+localStorage.getItem("token")}})).success&&(alert("Profile photo removed successfully!"),$("#profilePhotoImg").hide(),$("#avatarDisplay").show(),$("#deletePhotoBtn").hide(),$("#profilePhotoInput").val(""),await loadProfileData())}catch(e){console.error("Error deleting photo:",e),alert("Error removing photo")}}),document.addEventListener("DOMContentLoaded",function(){const e=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&(t.target.style.opacity="0",t.target.style.transform="translateY(30px)",setTimeout(()=>{t.target.style.transition="opacity 0.6s, transform 0.6s",t.target.style.opacity="1",t.target.style.transform="translateY(0)"},100),e.unobserve(t.target))})},{threshold:.1});document.querySelectorAll(".step-card").forEach(t=>{e.observe(t)})}),$(window).on("popstate",function(){handleURLParams()}),$(window).on("hashchange",function(){handleURLParams()});const originalPushState=history.pushState,originalReplaceState=history.replaceState;history.pushState=function(){originalPushState.apply(history,arguments),handleURLParams()},history.replaceState=function(){originalReplaceState.apply(history,arguments),handleURLParams()},$("#navbarAvatar").css("display","none"),document.addEventListener("DOMContentLoaded",async function(){if(console.log("🚀 Application starting..."),!await checkStandaloneMode()){try{if(await api.checkAuthStatus())try{const e=await api.getCurrentUser();if(e.success){currentUser=e.user,updateAuthUI();const t=await api.getProfile();t.success&&t.profile?($(".profile-photo-section").show(),await loadProfileData(),setUserEmail(currentUser.email),$("#navbarAvatar").show(),showPage("display"),$("#footer-cta").addClass("display-none-cta-button"),$("#footer-cta").removeClass("cta-section"),$("#singup-cta-button-div-uc").addClass("display-none-cta-button"),$("#singup-cta-button-div-uc").removeClass("usecase-cta"),handleURLParams()):(console.log("📝 No active profile found, showing Profile creation"),$(".profile-photo-section").hide(),setUserEmail(currentUser.email),showPage("profile"))}}catch(e){console.error("❌ User initialization error:",e),currentUser=null,handleURLParams()}else console.log("❌ User not authenticated, showing home page"),currentUser=null,handleURLParams(),$("#footer-cta").removeClass("display-none-cta-button"),$("#footer-cta").addClass("cta-section"),$("#singup-cta-button-div-uc").removeClass("display-none-cta-button"),$("#singup-cta-button-div-uc").addClass("usecase-cta")}catch(e){console.error("❌ Auth check error:",e),currentUser=null,handleURLParams(),$("#footer-cta").removeClass("display-none-cta-button"),$("#footer-cta").addClass("cta-section"),$("#singup-cta-button-div-uc").removeClass("display-none-cta-button"),$("#singup-cta-button-div-uc").addClass("usecase-cta")}updateAuthUI();const e=new URLSearchParams(window.location.search);"success"===e.get("auth")?(console.log("🎉 OAuth success detected"),showSuccessMessage("Successfully logged in!"),setTimeout(async()=>{const e=await api.getProfile();e.success&&e.profile?showPage("display"):showPage("profile")},1e3),window.history.replaceState({},document.title,window.location.pathname)):e.get("error")&&(console.log("❌ OAuth error detected:",e.get("error")),showErrorMessage("Login failed. Please try again."),handleURLParams(),$("#footer-cta").removeClass("display-none-cta-button"),$("#footer-cta").addClass("cta-section"),$("#singup-cta-button-div-uc").removeClass("display-none-cta-button"),$("#singup-cta-button-div-uc").addClass("usecase-cta"))}console.log("✅ Application initialized")});